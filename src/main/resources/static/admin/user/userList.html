
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html"; charset="utf-8" />
    <title></title>
    <link href="../css/table.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="/layui/css/layui.css">
    <link href="../css/animate.css" rel="stylesheet"/>
    <link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="../css/font-awesome.min.css" rel="stylesheet"/>
    <link href="../css/style.css" rel="stylesheet"/>
    <link href="../css/ry-ui.css" rel="stylesheet"/>
    <style>
        .layui-table-cell .layui-form-checkbox[lay-skin="primary"]{top: 48%;transform: translateY(-48%);}
        .layui-table-fixed.layui-table-fixed-r .layui-table-body tr{background-color: white}
    </style>
</head>
<body style="background-color: #ecf0f5;font-family: 微软雅黑;color: #475059;min-width: 1000px;overflow: auto">
<div class="container-div">
    <div class="row">
        <div class="col-sm-12 select-info">
            <form id="layui-form">
                <div class="select-list">
                    <ul>
                        <li>
                            邮箱：<input type="text" name="dictLabel" style="width: 200px;"/>
                        </li>
                        <li>
                            所属角色：
                            <select id="permType" name="permType" lay-verify="permType" style="width: 200px">
                                <option value=""></option>
                                <option value="0">博主</option>
                                <option value="1">管理员</option>
                                <option value="2">普通用户</option>
                            </select>
                        </li>
                        <li>
                            <a class="btn btn-primary btn-rounded btn-sm"><i class="fa fa-search"></i>&nbsp;搜索</a>
                            <a class="btn btn-success btn-rounded btn-sm"><i class="fa fa-download"></i>&nbsp;导出</a>
                        </li>
                    </ul>
                </div>
            </form>
        </div>
        <div class="col-sm-12 select-table table-striped">
            <div class="btn-group hidden-xs" id="toolbar" role="group" style="margin-top: 10px">
                <a class="btn btn-success" id="addUser" onclick="addUser()"><i class="fa fa-plus"></i> 新增</a>
            </div>
            <div class="btn-group hidden-xs" id="toolbar1" role="group" style="margin-top: 10px">
                <a class="btn btn-danger" id="cz" onclick="reset_password()"><i class="fa fa-cog"></i> 重置密码</a>
            </div>
            <div class="btn-group hidden-xs" id="toolbar2" role="group" style="margin-top: 10px">
                <a class="btn btn-warning" id="ty"><i class="fa fa-trash-o"></i> 账号停用</a>
            </div>
            <table id="table" class="layui-hide" lay-filter="tableEvent" style="margin: 0 auto"></table>
        </div>
    </div>
</div>
<div id="barDemo" style="display:none;">
    <a class="btn btn-success btn-xs" lay-event="edit"><i class="fa fa-edit"></i> 编辑</a>
    <a class="btn btn-primary btn-xs" lay-event="reset"><i class="fa fa-cog"></i> 重置</a>
    <a class="btn btn-danger btn-xs" lay-event="delete"><i class="fa fa-trash-o"></i> 停用</a>
</div>

<script type="text/html" id="valId">
    <span class='badge badge-primary' style="margin-top: 5px;">{{ d.valid == 1 ? '正常' : '停用'}}</span>
</script>


<script type="text/javascript" src="../js/jquery/jQuery-2.2.0.min.js"></script>
<script type="text/javascript" src="../js/bstable/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../js/bstable/js/bootstrap-table.js"></script>
<script type="text/javascript" src="../js/bstable/js/bootstrap-table-zh-CN.min.js"></script>
<script src="../layuiTablePlug/layui/src/layui.js"></script>
<script type="text/javascript" src="/common/util.js"></script>
<script>
    $(function () {
        change();
    });

    function change(){
        $(".dropdown-menu>li").click(function(){
            $(".change").html($(this).html())
        })
    }

    var ind;
    var nowPage;
    layui.config({base: '../layuiTablePlug/test/js/'}).use(['testTablePlug'], function () {
        var table = layui.table,
            form = layui.form;

        //监听工具条
        table.on('tool(tableEvent)', function(obj){
            var data = obj.data;
            if(obj.event == 'delete'){//查看
                var lock = false; //默认未锁定
                top.layer.confirm("确定停用该条数据信息吗？", {
                    btn: ["确定","取消"], //按钮
                    title: "提示",
                    icon: 3
                }, function(index){
                    if(!lock) {
                        lock = true;
                        var userIds = [];
                        userIds.push(data.id);
                        $.ajax({
                            url: basePath + "admin/disableUserInfo",
                            type:"POST",
                            data:JSON.stringify(userIds),
                            dataType:"json",
                            contentType : 'application/json;charset=utf-8',
                            success:function(resultData){
                                if(resultData.code==0){
                                    parent.layer.alert(resultData.msg);
                                    layReload();
                                }else{
                                    parent.layer.alert(resultData.msg);
                                }
                            }
                        });
                    }
                    layer.close(index);
                }, function(){

                });
            }else if(obj.event == 'edit'){
                top.layer.open({
                    type: 2,
                    title: "编辑用户",
                    shadeClose: true,
                    shade: 0.5,
                    closeBtn:1,
                    area: ['800px', '600px'],
                    content: '../admin/user/addOrUpdaUser.html?type=update&userId='+data.id,
                    end: function () {//层消失回调
                        layReload();
                    }
                });
            }else if(obj.event == 'reset'){
                var lock = false; //默认未锁定
                top.layer.confirm("初始化密码为12345678,确定要重置吗？", {
                    btn: ["确定","取消"], //按钮
                    title: "提示",
                    icon: 3
                }, function(index){
                    if(!lock) {
                        lock = true;
                        var emails = [];
                        emails.push(data.email);
                        $.ajax({
                            url:basePath + "admin/resetPassword",
                            type:"POST",
                            data:JSON.stringify(emails),
                            dataType:"json",
                            contentType : 'application/json;charset=utf-8',
                            success:function(resultData){
                                if(resultData.code==0){
                                    parent.layer.alert(resultData.msg);
                                    location.reload();
                                }else{
                                    parent.layer.alert(resultData.msg);
                                }
                            }
                        });
                    }
                }, function(){

                });
            }
        });

        tableIns = table.render({
            elem: '#table'
            ,url: basePath + 'admin/queryUserList'
            ,method: 'post'
            ,contentType: "application/json; charset=utf-8"
            ,dataType:"json"
            ,skin:'nob'// 无边框风格
            ,loading: true
            // 是否开启字段筛选的记忆功能，支持true/false/'local'/'session'/其他 开启的情况下默认是session，除非显式的指定为'local'
            ,colFilterRecord: true
            // 是否开启智能reload的模式
            ,smartReloadModel: true
            ,cols: [[
                {checkbox: true, id:"idTest", width:'2%', align:'center'}
                ,{field:'rk', title:'序号', width:'5%', align:'center'}
                ,{field:'nickname', title:'用户昵称', width:'15%', align:'center',
                    templet : function(data) {// 替换数据
                        if(data.nickname == null){
                            return "暂无";
                        }else{
                            return data.nickname;
                        }
                    }
                }
                ,{field:'email', title:'用户邮箱', width:'16%', align:'center',
                    templet : function(data) {// 替换数据
                        if(data.email == null){
                            return "暂无";
                        }else{
                            return data.email;
                        }
                    }
                }
                ,{field:'sex', title:'性别', width:'5%', align:'center',
                    templet : function(data) {// 替换数据
                        return "男";
                    }
                }
                ,{field:'rolename', title:'所属角色', width:'10%', align:'center',
                    templet : function(data) {// 替换数据
                        if(data.rolename == null){
                            return "暂无";
                        }else{
                            return data.rolename;
                        }
                    }
                }
                ,{field:'signature', title:'个性签名', width:'19.7%', align:'center',
                    templet : function(data) {// 替换数据
                        if(data.signature == null){
                            return "暂无";
                        }else{
                            return data.signature;
                        }
                    }
                }
                ,{field:'valid', title:'账号状态', width:'10%', align:'center', templet:'#valId'}
                ,{field:'toolses', title:'操作', width:'17.4%', align:'center', toolbar: '#barDemo'}
            ]]
            ,id:"idTest"
            , done: function () {
                $('th').css({ 'color': 'black', 'font-weight': 'bold'})//用于设置表头的样式，th即代表表头
                $(".layui-table-box").css("border-width","0px");
                $(".layui-table-header tr").css("height","25px");
                $(".layui-table-header tr span").css("color","#666666");
                $(".layui-table-body tr").css("height","25px");
                $(".layui-form-checkbox").css("style","margin-top: 5px;");
            }
            ,height : "full-195"
            ,page: { //支持传入 laypage 组件的所有参数（某些参数除外，如：jump/elem） - 详见文档
                layout: ['limit', 'count', 'prev', 'page', 'next', 'skip'] //自定义分页布局
                //,curr: 5 //设定初始在第 5 页
                ,groups: 1 //只显示 1 个连续页码
                ,first: false //不显示首页
                ,last: false //不显示尾页
            }
        });

    });


    function addUser(){
        top.layer.open({
            type: 2,
            title: '添加新用户',
            shadeClose: true,
            shade: 0.5,
            closeBtn:1,
            area: ['790px', '680px'],
            content: '../admin/user/addOrUpdaUser.html?type=add',
            end: function () {//层消失回调
                layReload();
            }
        });
    }

    function reset_password(){
        var checkedObjs = layui.table.checkStatus('idTest');//获取所有选中的节点
        if(checkedObjs.data.length < 1){
            layer.msg("请选择要重置的用户数据！");
            return false;
        }

        var lock = false; //默认未锁定
        top.layer.confirm("初始化密码为12345678,确定要重置吗？", {
            btn: ["确定","取消"], //按钮
            title: "提示",
            icon: 3
        }, function(index){
            if(!lock) {
                lock = true;
                var emails = [];
                for(var i = 0;i < checkedObjs.data.length;i++){
                    emails.push(checkedObjs.data[i].email);
                }
                $.ajax({
                    url:basePath + "admin/resetPassword",
                    type:"POST",
                    data:JSON.stringify(emails),
                    dataType:"json",
                    contentType : 'application/json;charset=utf-8',
                    success:function(resultData){
                        if(resultData.code==0){
                            parent.layer.alert(resultData.msg);
                            location.reload();
                        }else{
                            parent.layer.alert(resultData.msg);
                        }
                    }
                });
            }
        }, function(){

        });
    }

    //查询条件
    function layReload(page){
        /*  */
        tableIns.reload({
            where: { //设定异步数据接口的额外参数，任意设
                id:"",
            }
            ,page: {
                layout: ['limit', 'count', 'prev', 'page', 'next', 'skip'] //自定义分页布局
                ,curr: (!!page?page:nowPage) //重新从第 1 页开始
                ,groups: 1 //只显示 1 个连续页码
                ,first: false //不显示首页
                ,last: false //不显示尾页
            }
        });
    }
</script>
</body>
</html>
