
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>无标题文档</title>
    <link rel="stylesheet" href="/layui/css/layui.css">
    <link href="../js/bstable/css/bootstrap-table.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/semantic-ui/dist/semantic.min.css">
    <link href="/admin/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="../css/animate.css" rel="stylesheet"/>
    <link href="../css/style.css" rel="stylesheet"/>
    <link href="../css/tail.css" rel="stylesheet" type="text/css">
    <link href="../css/table.css" rel="stylesheet" type="text/css" />
    <style>
        .department_main label{width: 10%;text-align: right;font-size: 12px}
        .department_main input, .department_main select{margin-right: 1%;height: 32px;border: 1px #ccc solid;background-color: #fff;border-radius: 4px;padding-left: 6px;}
        .layui-form-radio {line-height: 28px;margin: 6px 10px 0 0;padding-right: 1px;cursor: pointer;font-size: 0;}
        .layui-form-select {width:473px;}

        .layui-form .blog-file-image img {
            width: 100%;
            height: 100%;
        }
        .layui-form .blog-file-image {
            float: left;
            background: #ffffff;
            width: 35px;
            height: 35px;
            margin-right: 10px;
            border-radius: 2px;
            position: relative;
        }
        .layui-form .blog-btn-file {
            float: left;
            background: #ffffff;
            margin-right: 10px;
            margin-bottom: 10px;
            width: 35px;
            height: 35px;
            position: relative;
            border-radius: 2px;
        }
        .layui-form .blog-btn-file input[type=file] {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0px;
            left: 0px;
        }
        .layui-form .blog-btn-file .blog-btn-name {
            text-align: center;
            background: #ecf0f5;
            height: 35px;
            padding-top: 30%;
        }
    </style>
</head>
<body style="border-radius: 8px;width: 680px;overflow: hidden">
<form id="frm" class="layui-form" action="">
    <div id="tools-box" class="wrapper wrapper-content animated fadeInRight ibox-content" align="left">
        <div class="department_main">
            <div class="layui-form-item">
                <label class="layui-form-label" style = 'width: 189px'>上传头像：</label>
                <div class="layui-input-block">
                    <div class="blog-file-image">
                        <input type="hidden" id="userId" name="userId">
                        <img id="icon" src="../img/icon.png" />
                    </div>
                    <div class="blog-btn-file">
                        <input type="file" accept="image/*" class="layui-upload-img" id="blog-image" name="file">
                        <div class="blog-btn-name">
                            <p class="fa fa-folder-open-o"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="department_main">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label" style = 'width: 189px'><font color='red'>*</font>&nbsp;用户昵称：</label>
                    <div class="layui-input-inline">
                        <input type="text" name="nickname" id="nickname" lay-verify="nickname" autocomplete="off"
                               class="layui-input" style="width: 473px">
                    </div>
                </div>
            </div>
        </div>
        <div class="department_main">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label" style = 'width: 189px'><font color='red'>*</font>&nbsp;邮箱：</label>
                    <div class="layui-input-inline">
                        <input type="text" name="email" id="email" lay-verify="email" autocomplete="off"
                               class="layui-input" style="width: 473px">
                    </div>
                </div>
            </div>
        </div>
        <div class="department_main" id="isAccord">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label" style = 'width: 189px'><font color='red'>*</font>&nbsp;密码：</label>
                    <div class="layui-input-inline">
                        <input type="password" name="pwd" id="pwd" lay-verify="pwd" autocomplete="off"
                               class="layui-input" style="width: 473px" value="12345678">
                    </div>
                    <span class="help-block m-b-none" style="margin-top: 40px;margin-left: 189px;"><i class="fa fa-info-circle"></i> 初始化密码为12345678</span>
                </div>
            </div>
        </div>
        <div class="department_main">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label" style = 'width: 189px'>性别：</label>
                    <div class="layui-input-inline" id="sex" name="radio">
                        <!--<input type="radio" name="sex" value="0" title="男" checked="">
                        <input type="radio" name="sex" value="1" title="女">
                        <input type="radio" name="sex" value="2" title="未知">-->
                    </div>
                </div>
            </div>
        </div>
        <div class="department_main">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label" style = 'width: 189px'>所属角色：</label>
                    <div class="layui-input-inline" id="roleid" name="radio" style="width: 400px">
                        <!--<input type="radio" name="js" value="0" title="博主">
                        <input type="radio" name="js" value="1" title="管理员">
                        <input type="radio" name="js" value="2" title="普通用户" checked="">-->
                    </div>
                </div>
            </div>
        </div>
        <div class="department_main">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label" style = 'width: 189px'>账号状态：</label>
                    <div class="layui-input-inline" id="valid" name="radio">
                        <!--<input type="radio" name="valid" value="1" title="正常" checked="">
                        <input type="radio" name="valid" value="0" title="停用">-->
                    </div>
                </div>
            </div>
        </div>
        <div class="department_main">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label" style = 'width: 189px'>个性签名：</label>
                    <div class="layui-input-inline">
                        <textarea name="signature" id="signature" class="layui-textarea" style="width: 473px"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="notice_bot" style="z-index: 0">
        <div class="r_right but_p">
            <div class="layui-btn but_save" id="nsbc" lay-filter="save" lay-submit="">保存</div>
            <div class="layui-btn but_close" id="close" onclick="Cancel()">关闭</div>
        </div>
    </div>
</form>
<script type="text/javascript" src="../js/jquery/jQuery-2.2.0.min.js"></script>
<script src="/semantic-ui/dist/semantic.min.js"></script>
<script type="text/javascript" src="../js/ztree/jquery.ztree.all-3.5.js"></script>
<script type="text/javascript" src="../js/ztree/jquery.ztree.exedit-3.5.js"></script>
<script src="/layui/layui.all.js"></script>
<script src="/common/util.js"></script>
<script>
    var type = GetQueryString("type");
    var id = GetQueryString("userId");

    layui.use(['form','layer','jquery','table', 'laydate', 'element'], function(){
        var table = layui.table,
            form = layui.form
            ,layer = layui.layer
            ,$ = layui.jquery
            ,laydate = layui.laydate
            ,element = layui.element
            ,upload = layui.upload;

        findCodeValue(form);

        //普通图片上传
        var uploadInst = upload.render({
             elem: '#blog-image'
            ,url: basePath + '/admin/uploadIcon' //改成您自己的上传接口
            ,type:"POST"
            ,data: {
                userId: function() {
                    return $("input:hidden[name='userId']").val();
                }
            }
            ,accept: 'images'
            ,before: function(obj){
                //预读本地文件示例，不支持ie8
                obj.preview(function(index, file, result){
                    $('#icon').attr('src', result); //图片链接（base64）
                });
            }
            ,done: function(res){
                //如果上传成功
                if(res.code == 0){
                    $("#userId").val(res.data[0].split("_")[0]);
                    return layer.msg('上传成功');
                }else{
                    return layer.msg('上传失败');
                }
            }
            ,error: function(){
                //演示失败状态，并实现重传
                var demoText = $('#demoText');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-xs demo-reload">重试</a>');
                demoText.find('.demo-reload').on('click', function(){
                    uploadInst.upload();
                });
            }
        });

        form.verify({
            nickname:function(value) {
                if (value.length < 1) {
                    return '昵称不能为空！';
                }
            },
            email:function(value) {
                if (value.length < 1) {
                    return '邮箱不能为空！';
                }
                var myreg = /^([\.a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(\.[a-zA-Z0-9_-])+/;
                if(!myreg.test(value)){
                    return '邮箱格式错误！';
                }
            },
            pwd:function(value) {
                if (value.length < 1) {
                    return '密码不能为空！';
                }
            }
        });

        if(type == "update"){
            $("#isAccord").hide();
            $.ajax({
                url: basePath + "admin/queryUserList",
                data:JSON.stringify({"id":id}),
                type:"POST",
                async:false,
                contentType : 'application/json;charset=utf-8',
                success:function(resultData){
                    console.log(resultData);
                    var data = resultData.data[0];
                    $("#userId").val(data.id);
                    if(null != data.iconUrl && '' != data.iconUrl){
                        $("#icon").attr("src",basePath + "/profile/"+data.iconUrl);
                    }
                    $("#nickname").val(data.nickname);
                    $("#email").val(data.email);
                    $("#signature").val(data.signature);
                    $("#sex").find('input[value=' + resultData.data[0].sex + ']').prop("checked",true);
                    $("#roleid").find('input[value=' + resultData.data[0].roleId + ']').prop("checked",true);
                    $("#valid").find('input[value=' + resultData.data[0].valid + ']').prop("checked",true);

                    form.render("radio");
                }
            });
        }

        //监听提交
        form.on('submit(save)', function(data){
            var userId = $("#userId").val();
            var email = data.field.email;//用户邮箱
            var sex = data.field.sys_user_sex;//性别
            var nickname = data.field.nickname;//用户昵称
            var password = data.field.pwd;//用户密码
            var roleId = data.field.role;//角色id
            var signature = data.field.signature;//个性签名
            var valid = data.field.sys_normal_disable;//状态
            var paramData = {
                id : id,
                userId : userId,
                email : email,
                sex : sex,
                nickname : nickname,
                password : password,
                roleId : roleId,
                signature : signature,
                valid : valid
            }
            $.ajax({
                url: basePath + "admin/addOrEditUserInfo?type="+type,
                type:"POST",
                data:JSON.stringify(paramData),
                dataType:"json",
                contentType : 'application/json;charset=utf-8',
                success:function(resultData){
                    if(resultData.code==0){
                        parent.layer.alert(resultData.msg);
                        var index = parent.layer.getFrameIndex(window.name);
                        parent.layer.close(index);//关闭当前页
                    }else{
                        parent.layer.alert(resultData.msg);
                    }
                }
            });
        });
    });

    //字典初始化
    function findCodeValue(form){
        loadRadio("#sex", "sys_user_sex", form);
        loadRadio("#roleid", "role", form);
        loadRadio("#valid", "sys_normal_disable", form);
    }

    /**
     * 邮箱失焦事件
     */
    $("#email").blur(function(){
        var value = $(this).val();
        if(value != null && value != ''){
            var falg = vailEmail(this,value);
        }
    });

    function vailEmail(elem,value){
        var myreg = /^([\.a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(\.[a-zA-Z0-9_-])+/;
        if(!myreg.test(value)){
            parent.layer.msg("邮箱格式错误！");
            return 1;
        }
        return 0;
    }
</script>
</body>
</html>
